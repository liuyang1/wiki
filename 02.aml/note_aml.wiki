= DevLog of Low latency of USB =

- 12-13            Assign task from @Shuai
                   requirement discussion with @Daozai

- 12-14 19:41      replace lib              <= OK

- 12-15 10:52      Default MS12 status?     <= Dcv!!
                   hw_write -> aml_alsa_output_write !!
-       11:31      aml_alsa_output_open's config
                    <= 8ch, 16bit(1), 48KHz

-       16:52       init HMixer for test
        18:24       check ret of pcm_read/pcm_write     <= -9
                    switch from PDM to TDM-A

- 12-16 10:12       avali_min = 0                       <= 依然是-9
        10:52       switch back to PDM + first init in **adev_open**
        15:12       follow tinycap's status             <=
        `tinycap /data/a.pcm -d 0 -r 48000 -c 2 -b 16`

- 12-19 16:23       pcm_read get 0 >> try more times
        16:34       enlarge read buffer + tune log
        16:45       add log, read buffer, reset buf
        17:00       add log on pcm_read
        17:22       add log on timespec + speaker config, shrink buffer size
        17:36       only read       <= 4,036,859us
                    only write      <= 7,860,171us ???
                    read+write
        18:19       wirte+config

- 12-20 14:00       test only write speed
        14:07       use TDM-C for playback      <= 3,945,934us
        14:17       read(TDM-A)+write(TDM-C)    <= 4,014,959us
<<< read+write in ONE task is possible
        15:25       test delay (period=2048)    <= avail=2048+-
        15:41       test delay (period=192)

| period | avail avg | comment   |
|--------|-----------|-----------|
| 2048   | 5622 117ms| buf=192   |
| 1024   | 2195 46ms | *default* |
| 512    | 999  21ms | buf=192   |
| 384    |           | buf=384   | WRONG: 8s
| 384    | 875 18ms  | buf=192   | reset many times
| 384    | 759 16ms  | buf=192   | start_thr=384, out start_thr=768
| 384    |           | buf=192   | start thr=384, out start_thr=768, cpu23
| 384    | 1536 20ms | buf=192   | start_thr=384, out start_thr=384, cpu23
| 192    | BAD       | buf=192   | reset many times, cpu23
| 192    | 435 9ms   | buf=192   | reset many times

- 12-21 *Build with hires*
- 12-22 15:32       SUBMIXER_V1_1

| input config | output config | period | theory | real | comment |
|--------------|---------------|--------|--------|------|---------|
| 384x(4,1)    | 384x(4,2)     | 192    | 384x3  | 609 13ms |
| 384x(4,1)    | 384x(4,2)     | 192    | 384x3  | 653 14ms | GOOD
| 384x(4,1)    | 384x(4,2)     | 384    | 384x3  | 537 11ms | GOOD
| 384x(4,1)    | 384x(4,1)    | 384 | 384x2 |
| 384x(8,1)    | 384x(8,2)     | 384    | 384x3  | 300 6ms  | GOOD, 不能复现
| 384x(8,1)    | 384x(8,2)     | 384    | 384x3  | 2451 51ms| double-check
| 384x(16,2)   | 384x(16,2)    | 384    | 384x4  | 5504 115ms ｜buffer太大了导致的问题？
| 384x(8,1)    | 384x(8,1)     | 384    | 384x2  | 1841 38ms | BAD
| 192x(16,2)   | 192x(16,2)    | 192    | 192x4  | 2470 51ms | BAD

>>> 结论：没有什么特别的线索。估计20ms还是有可能的。进一步的数值，过于不稳定了.

- 12-23 10:48       PCM-LINK    <= CANNOT work, EBUSY
        14:38       loop test with period, 64*(4,2) is best, 196, 112
                    64, 152
        15:47       default task
                    task FIFO
                    task Round-Robin        <= 64, mean ratio=0.98, var-ratio=6.27
>>> 结论：affinity或者sched都可以提高task的调度，能够满足要求. 同时设置两个值，取得更好的结果


- 12-26 13:36       define SUBMIXER_V1_1, ~~ no audio ~~
                    disalbe SUBMIXER_V1_1 <= GDOO
                    remove hmixer test+define SUBMIXER_V1_1 <= GOOD
                    usercase_change_validate_l_sm <=

+-------------------+
| audio_hw/hw_write |
+-------------------+

+-------------------------------------------+
| sub_mixing_factory/out_write_subMixingPCM |
| - consume_output_data                     |
| - out_write_system                        |
| - out_write_direct_pcm                    |
| - **mixer_aux_buffer_write_sm**           |
| - mixer_mmap_buffer_write_sm              |
| aml_out_write_to_mixer/mixer_write_inport |
+-------------------------------------------+

+---------------------------------------------------------+
| mixer_write_inport                                      |
| mixer_inports_read/mixer_read_inport                    |
| amlAudioMixer.c/mixer_16b_threadloop/mixer_output_write |
+---------------------------------------------------------+

+------------------------+
| audio_port.c           |
| output_port_write_alsa |
+------------------------+

- 12-27 10:48       debug linein-kara module
|cpu | prio | result=(mean,var) |
|----|------|-------------------|
| 23 | FIFO | 1756, 4500+-      |
| 23 | RR   | 1750+,4000        |
| 1  | FIFO |                   |
| 1  | RR   | 1792, **0**/4000  |

Current Task List

- ATVRemoteAudioHotplug
- binder:PID_TASK
- vndbinder:PID_
- HwBinder:

# 12-28 **MS12 path **

- disable SUBMIXER_V1_1
- writer task, backtrace is bad
- add tinyalsa's `pcm_write` log

# 12-29 **MS12 path**

- DOLBY_MS12 task's status

# Design

it must work CONTINOUS mode

orignal, we have SubMix way
- SUBMIXER_V1_1     DISABLED
- USB_KARAOKE       DISABLED

# 2023-01-10

- Dolby Stream playback well
    - [X] efuse
    - [X] ms12 lib
- MS12 path
    - [X] game mode, 256 period size
- Kara path
    - [X] buffer frame <= 256
- LINE in
    - tinymix 73 7 <= select TDM-B source is acodec_adec
    - use LINE-in special line from laptop
    - 示波器测量正弦波信号
- [X] mix function
- [X] DUMP
- [X] stat
    256*4+512,256*8+512 => 1136~1221
    256*4+256,256*4+256 => 1279
- [X] 示波器测量latency
- [X] tinymix 73 7，TDM B source select acodec_adc, 自动选择的支持
    - aml_audio_input_routing

- adev_create_audio_path -> aml_audio_input_routing
- adev_set_parameters -> set_tv_source_switch_parameters -> aml_audio_input_routing

# Issue

- [ ] continuious MS12 path, 没播放的时候，MS12通路没数据。
- [ ] line in只有左声道有声音，右声道没声音

# HDMI Rx issue

audio_patch_output_threadloop -> out_write_new -> mixer_main_buffer_write
-> ms12_render
-> hw_write
-> ??

               +----------------+               +--------------+
               |                |  +---------+  |              |
               | +------------+ |  | pcm_read|  |  +-------+   |
 +-----------+ | | RENDER TSK | |  +---------+  |  | MS12  |   | +-------+
 | hr_render | | +------------+ |      |        |  +-------+   | | main  |
 +-----------+ |       |        |   +------+    |      |       | +-------+
       |       |       |        |   | KARA |    |      |       |     |
       +---------------|        |   +------+    |      |-------------+
               |       |        |      |        | +----------+ |
               |       |---------------+----------| hw_write | |
               |       |        |               | +----------+ |
               |       |        |               |      |       |
               | +-----------+  |               | +----------+ |
               | | pcm_write |  |               | | pcm_write| |
               | +-----------+  |               | +----------+ |
               +----------------+               +--------------+


2023-03-22 13:54:27
- [X] render start
- [-] render switch with different main device & config

相对来说，hires 需要混合多路的数据（这个多路在上层上的多路）因此需要port 这一层级
而对于当前任务来说，并不需要port这一层。甚至continous task也可以随时创建。那么我们就把它修改到stream layer

+------+   +------+
| data |   | kara |
+------+   +------+

+---------+ +--------+ +--------+
| stream  | | device | | render |
+---------+ +--------+ +--------+

+-------------------------------+
| dev,alsa,process              |
+-------------------------------+

- [X] render with fixed device, config, (virtual buffer)
- [X] ring buffer for input, pop ring buffer, playback

2023-03-23 10:26:23 
- [x] ticlog
     -----=====----___
设计一套状态指示的log
空白为dummy输出
下划线__为__仅有linein/usbin输出
---为仅有主路输出
====为kara输出
粒度为每个period（比如4ms）那么200个period大约为0.8s。时间粒度太小了

## finish
- [X] register render to hw_write or some where?
- [X] switch to FRAME (instead of bytes at API layer)
- [X] add dump support

+----+                                +----+
| WR |                                | RD |
+----+                                +----+
  |<---------------<<<<------------------|
  | take space (wait forever)            |
  || write, generate it                  |
  ||                                     |
  | post payload                         |
  |---------------->>>>----------------->|
  |                     try take payload |
  |                                      || read, consume it
  |                                      || give space

2023-03-24 15:51:04
- [X] 对比标准情况的配置和信息
标准情况，不会出现问题。检查配置

2023-03-27 13:52:16
- [ ] 检查，在同样配置下，是否会有问题
alsa open + alsa write   AAA 正常
alsa_open + pcm_write:   XXX 直接走pcm write就播放不了声音，那TDM还怎么搞啊，直接基于原有的API接口和模块来玩？
render open + alsa write: ???
render open + pcm write: XXX 无法播放

|            | alsa open | rnd open |
| alsa write | AAA       | XXX      |
| pcm write  | XXX       | XXX      |

为什么，替换掉哪一部分，看上去都不行，难道就原模原样照搬

- [X] render, directly use aml_alsa_output_open
    - [x] correct sequence to pcm_frame_to_bytes
- [.] render, directly use aml_alsa_output_write
- [X] render, use dummy buffer + task
- [o] add start_threshold for smooth playback
- [X] continuuse use old render
- [-] add ping-pong from hw_write to render task, to reduce polling when ring buffer write
- [X] add waiting to reduce polling

## output_mix_source=line
- [.] pcm_mic_open fail, check error
- [.] decrease threshold for playback

|      | output_mix=null | linein      |
| no   | DUMMY           | DUMMY+linein|
| main | main            | main+linein |

2023-03-28 10:21:50

- [x] move dummy to task to allocate
- [-] move all API based on frame, instead of bytes
- [x] clean card, device, pcm in render
- [x] error handling

validation
- [x] dummy?
- [x] playback
- [x] only line in
- [x] kara: playback + line in

re-format CL
- [.] format CL
- [x] render close


## TODO

## WIP
- [ ] process time, correct or not, it should not XRUN
## TODO
- [ ] correct period/frame size, 8ch output
## backlog
- [ ] commit(timestamp, frame position)
= SH-13464 =

hw_write
    -> aml_alsa_output_open
    -> 'pcm device already opened,close the %p handle to reopen'

out_write_new
    -> mixer_aux_buffer_write
    -> aml_alsa_output_close

mixer_aux_buffer_write
    -> aml_hw_mixer_write
mixer_main_buffer_write
    -> aml_audio_nonm12_render
    -> $aml_hw_mixer_mixing$

# History

@Yujie, 'audio: don't close alsa when do flush'

# problem

- [o] lock on alsa_pcm_lock
- [X] aml_alsa_output_open, audio out... *refs>=12*
    - leave STREAM_HW_WRITING stream_status, need reopen, (but missing close??)
- [X] reopen when I2S device


# Tiny
- refine alsa_manager's log

= 2023-03-30 19:25:52 =
# Environment

- *MS12 enabled* (efuse key, ms12 lib)
    - non-MS12 doesn't have this issue (per my test)

ms12 cleanup & prepared

ms12_output -> {
    dap_pcm_output, -> ms12_output_master
    stereo_pcm_output, -> ring_buffer_write to spdif
    spdif_bitstream_output (SPDIF, format=0x90..)

~~MUST ms12 cleanup, otherwise it cannot playback~~

We must

= 2023-04-03 14:53:24 = 

|                         | Add new CL | Base |
| dolby ms12 cont, refs=1 | ??         | ??   |
| nonms12                 | GOOD       |      |

- [ ] stream_status, why it change leave from STREAM_HW_WRITING


= 2023WK15 =
== 96k feature ==
MIXER thread, PRIMARY, config to 96K, 32bit

- [ ] How to affect stream config from AudioFlinger side?? By policy??
    - [X] audio hw profile, add 96k => but main stream still be 48K
    - [ ] audio hw profile: ONLY support 96k for all cases => NOT work
    - [O] config xml?
        out_get_parameters_wrapper_about_sup_sampling_rates__channels__formats
config_output
out_write_new
    get_sink_format
        get_sink_capability
        get_sink_pcm_capability
            -> get_hdmi_sink_cap_new


- [ ] open stream (flags=direct, primary, ...)
    - [ ] out->hal_rate = config->sample_rate;
    - [ ] out->config.rate = config->sample_rate;
    - [ ] out->stream.common.get_sample_rate / set_sample_rate
- [.] out_get_buffer_size
- [.] adev->get_latency => audiohal_get_latency
- [.] adev_create_audio_path

- hwavsync stream??
- 32k to 48k

- pcm_open fail with 96k <= 2ch

=== 2023-04-12 15:49:57 ===
- [ ] good path to change to 2ch        <- board_config, bd_config alsa_default_ch=8
- [ ] keep 2ch data, bypass 8ch expand  <- reduce data

nonms12_render
-> audio_hal_data_processing_ms12v2
-> hw_write (8ch)

+------+
| stream |
+------+

+------+
| port |
+------+

+-------+
| render |
+-------+

+-------+
| pcm device |
+-------+

=== 2023-04-13 11:00:37 ===

- [x] check speed
    - update frame calc in hw_write
- [x] 96k support is good (keep high freq info)

out_get_presentation_position (frames, timestamp)

- [X] check Qing's 32bit patch <- GOOD, wav generated from DSD is 24bit precision (with 32bit format)
    - [x] 数据精度不对，为什么？？？ <- GOOD,不知道之前版本怎么了
- [ ] check Customer's code
== Journal ==
- Mon   hi-res的profile修改，
    - 测试hi-res usb设备
- Tue   hi-res的config。xml修改，发现pcm open fail问题。
    - 测试hi-res usb设备，验证zidoo OK
    - hisense, underrun, 澄清
        - TDM-A设备只支持到2ch，96KHz
        - TDM-B（HDMI I2S）支持到8ch，48KHz（不支持96K）
    - 我们先用2ch，96KHz继续试下
    - 实际数据是8ch，96KHz的，需要考虑去掉转换8ch的逻辑
- Thr
    - 梳理清楚2ch的配置来源
    - 梳理清楚8ch的expand的过程。修改为2ch的方式
    - 播放速率还有问题
- Wen
    - 播放速率没问题了（只要修改out get presention的ch，影响frame计算即可）
    - 加上Qing的patch 32bit原始精度输出也没问题了
    - 下一步：在客户版本上测试

= UAC for lavaudio =

UAC: USB Audio C?

snd_usb_set_sample_rate_v2v3 <- err=-71 EPROTO, EREMOTE (uapi/asm/errno.h)
-> snd_usb_ctl_msg
    -> usb_control_msg
        -> usb_internal_control_msg
            -> usb_start_wait_urb
                -> usb_submit_urb,ctx.status
                    --> map_urb_for_dma
-> get_sample_rate_v2v3

hub_probe REGISTER
    hub_port -> port_event -> port_over_current_notify -> hub_port_connect_change -> hub_port_connect
finish_port_resume
usb_reset_device -> usb_reset_and_verify_device
==> hub_port_init
    r = -EPROTO

== 2023-04-17 10:25:39 ==
- [ ] check customer's board (support TDM-A, 96k, 32bit, 8ch or not) <- depend on RongQi's preparation

== Issue ==
- [x] Hisense:  underrun with low latency buffer
- [x] Hisense:  no output when force to unpluged devices    => discussion   => HongChao => Qitao
- QiNuo:    Mixing with HW                      => Pending
- BT:       hi-res 96k                           => PCM open fail    => temp change to TDM-A
- Skyworth: hi-res nego

= 2023-04-19 17:28:17 =

== env ==
board:      S5 AX201 S928X
Image:      Download for tyson
Jenkins:    Tyson
Code:       Android R 32bit

MS12:       MS12 DONE
HDMI device: TDM-C
default stream: 48k 2ch 16bit
device support: 48k 2ch 16bit/96k 2ch 32bit

= 2023-04-20 =
- !!! Its speed have 2x slow when playback 96k 4ch 32bit        => report to JianZhou+teams
- [ ] It fail to connect with 功放

上次可以被auido policy configuration xml影响，从而改变上层的输出sample rate。但是底层的sample rate不变，恒定为48000。

为什么?

adev -> stream -> amlAudioMixer.c -> audio_port.c

amlAudioMixer.c

init_mixer_output_port -> mixer_16b_threadloop -> mixer_output_write -> mixer_output_startup

    TCL电视不支持DD+（尽管aud cap汇报说支持，因此tinymix 91 0，切换到spdif A输出，spdif A走DD输出，从而避免这个问题）

adev_get_hal_control_volume_en

MS12必须输出为48K


= MBI timestamp =
sys_get_local_cur_pts(osal_sched_clock)

audio:: CALL_SYS_GET_TIME_STAMP sys_get_time_stamp (local_cur + base - init)

sys_get_local_time_stamp
sys_sync_time_stamp

= 2023-04-23 10:58:20 =
- clean up ms12 when user set fix_device=hdmi
- when user create patch "DEVICE=OUT_HDMI"

= 2023-04-24 13:54:39 = 
- [x] audiotrack-test with DIRECT stream
- direct stream
- 在默认走MS12的情况下，MS12部分会把direct stream转换成48k输出

- A,                    closed
- B,                    closed
- C,                    48k 16bit 2ch
- D,                    closed
- PDM, capture only
- SPDIF                 48k 16bit 2ch
- SPDIF-B               48k 16bit 2ch
- LOOPBACK, capture only
- EARC, capture only

playback direct stream 96000, only TDM-C works
playback direct stream 48k, only TDM-C works at 48k 16bit ch, good

找到了转sample rate的位置（在nonms12中间），那么就可以进一步转换成想要的sample rate

| stream | MS12 | nonms12 |   |
|--------|------|---------|---|
| 96k    | c48k |         |   |
| 48k    | c48k |         |   |
| 32k    | c48k |         |   |

TODO

- [x] select output rate, negotiate
- [x] dynamic sample rate
- [ ] SPDIF sink select + profile
取不同的sample rate

RecordThread::createAudioPatch_l
    EffectChain::setInputDevice_l
onCreatePatch
    checkPort
        EffectChain::setInputDevice

RecordThread::threadLoop
    EffectChain::process_l


? PlaybackTrack::isDirect isOffloadOrDirect
x AudioHwDevice::openOutputStream
x AudioFlinger::openMmapStream
  AudioFlinger::openOutput_l -> DirectOutputThread
  AudioFlinger::PlaybackThread::createTrack_l


/frameworks/av/media/libmediaplayerservice/nuplayer
/vendor/amlogic/common/amnuplayer (source code, before prebuilt)

= amnuplayer =
owner: Qiang Guo
origin: build-time: 2023-04-11

nuplayer -> Render
-> mAudioSink (/frameworks/av/media/libmediaplayerservice/MediaPlayerService.cpp)
-> mAudioTrack (...)

== Where to load libamnuplayer ==

/vendor/amlogic/common/frameworks/av/mediaextconfig/AmLoadAmlogicPlayers.cpp

/frameworks/av/media/mediaserver/main_mediaserver.cpp::main
-> registerExtensions
-> LoadAndInitAmlogicSupport -> LoadAndInitAmlogicMediaFactory

== WHY goto sub_mixing_factory ==

initSubMixingInputPcm
switchNormalStream
    out_write_subMixingPCM

因为ms12库的问题

0. Image
1. MS12库
2. 功放设备
3. amnuplayer
4. audio hal（我的改动）
5. 配置文件
6. driver DTS

= output device =

- TDM-A
- TDM-B         i2s2hdmi
- TDM-C         i2s
- TDM-D
- SPDIF         spdif
- SPDIF-B       spdifb

目前可选择按照TDM-B，TDM-C，spdif播放出去

TDM-C samesource到spdif。因此HDMI Tx选择spdif即可
TDM-B，需要HDMI Tx选择tdm-b输出
spdif，需要hdmi tx选择spdif输出(实际上会spdif和hdmi双输出。如果只想要hdmi，则tinymix spdif mute即可）

= usb audio HAL =
- S5 platform check USB => 默认96k，2ch，32bit输出
usb hal:
    hardware/libhardware/modules/usbaudio
usb alsa proxy part:
    system/media/alsa_utils

sup_sampling_rates=96000|88200|192000|176400|48000|44100
44100, 48000, 88200, 96000, 176400, 192000, 352800, 384000, 705600, 768000.

== zidoo支持情况 ==
- 一般音频，pcm 48KHz
- DSD，DSD 2.82MHz

= Mixer的sample rate是何处决定的 =
- 修改了返回的sup sample rate列表的顺序。 不是的。
- audio policy配置文件。发现也不是的

void AudioFlinger::PlaybackThread::readOutputParameters_l()
{
    const audio_config_base_t audioConfig = mOutput->getAudioProperties();
    mSampleRate = audioConfig.sample_rate;


AudioStreamOut *mOutput

- 有配置文件，走配置
- 没配置，走支持的最大sample rate
- 不看支持的顺序
- 也不看0的时候的默认值

=== 为什么？？ ===
- AudioFlinger里面找了一遍，没找到。
- AudioPolicy应该有的。

AudioPolicyManager.cpp

    findBestMatchingOutputConfig(..., true /* preferHigherSamplingRates */, bestOutputConfig);
    sinkConfig->sample_rate = bestSinkConfig.sample_rate;

    status findBestMatchingOutputConfig
        auto sampleRates = preferHigherSamplingRates ? ...
        bestOutputConfig.sample_rate = *sampleRates.begin();

所以这里总是选择最高的sample rate

| lib | comment            | profile | 32k    | 44.1k | 48k | 96k | 192k | 384k   | dsd    |
| ori | drt,96k            |         | 96k    | 44.1k | 48k | 96k | !!-  | -      |        |
|     | drt,96k,skip scan  |         | !!192k | 44.1k |     | 96k | 192k | !!192k | !!192k |
| ori | drt,96k+,skip scan |         | !!768k | 44.1k | 48k | 96k | 192k | 384k   | 352.8k |
| ori | drt,96k+,skip scan | 96k     | *96k*  | 44.1k | 48k | 96k | 192k | 384k   | 352.8k |
| ori | drt,768k-          | 96k     | *96k*  | 44.1k | 48k | 96k | 192k | 384k   | 352.8k | <- final solution
| bak | drt,768k           |         | !!768k |       |     |     | 192k | 384k   | 352.8k |
|     | drt,48k,44.1k,768k |         | !!768k |       |     |     |      |        |        |

= Verify @ Jihui =
0. Image                tyson Jihui.Zhang@04281801
1. MS12库               0
2. 功放设备
3. amnuplayer           0
4. audio hal（我的改动）
5. 配置文件
6. driver DTS

- [x] 43579, usb播放44.1khz的流，没有按照48khzresample
- [ ] 43582, 352800的patch，应该没加入。QA再次测试
- [ ] 43581, 需要QA复测验证

== 43578 ==
选择spdif，播放176k，结果按照48k输出

= C3audio =
原理图检查

- 找到audio章节，analog amp就是模拟放大器。这里的输入为【2】AU_LOL，【2】表示，这里引用第二页说明。
- 第二页是CPU IO部分，可以找到AU LOL的pin脚
- AU_LOL连接到7C56的输入部分。经过小芯片AD51652/NC/FT2011M的4口（IN-）进入。
- 这里的AD51652是Elite半导体的小芯片。这是个3W的单声道无滤波器的D类音频放大器

== USB 384k stream: why goto 384k direct even no direct at amnuplayer ==

1. amnuplayer: is_force_direct = *0*
2. getOutputForAttrInt (384khz, 16bit, 2ch, flag=*0x9*)
3. audiofligner: openOutput(384khz, 16bit, 2ch, flag=0x9)
4. usbaudio:audio_hal adev_open_output_stream(flags:0x9)

这个问题Hongchao继续check

== USB Combo384 Amanero ==

设备只支持32bit。

添加32bit的mixer profile支持        => 会按照32bit 96k下发

依然没有direct stream

= USB passthrough for Hisense =

== 调研 ==

- profile内增加相关的内容
- calling
    set_device_connect_state -> a2dp_out_open (adev->a2dp_hal)
    {hw_write, amlAudioMixer.c} -> a2dp_out_write
    a2dp_out_get_latency
    ad2p_out_get_latency
    ad2p_out_get_status

a2dp_hw.cpp/h 层次
    从audio bluetooth hw部分搬过来的代码

    BlueTtoothAudioPortOut a2dphw
    a2dphw.Setup(AUDIO_DEVICE_OUT_BLUETOOTH_A2DP)
    a2dphw.LoadAudioConfig()
        a2dphw.WriteData
    a2dphw.Stop()
    a2dphw.TearDown()

== Req ==
usb方式增加到primary hal里面，从而可以调用primary hal内的解码/播放等代码
支持各种压缩格式的透传，然后在hal内解码播放。

offload，tunnel，

== 问题 ==
连接usb，播放dolby，ac3，eac3片源，无法正常播放

播放卡断
period size 5ms -> ro.audio.usb.period_us
period count 2 -> 5
/mnt/fileroot2/yang.liu/FY23/koltin.BT_96K/system/media/alsa_utils/alsa_device_profile.c:117:1
start_thr

| 7680*4     | 11/222 |
| remove log |        |

| OLD    | bad   |
| 5ms*2  | bad*2 |
| 20ms*4 | good  |
| 80ms*4 | good  |

== stream ==

| name  | format | freq  | ch | bps   |
| Pian  | float  | 192k  | 2  | 24.6M | X
| Happy | mp3    | 44.1k | 2  | 96k   | OK
|       | 32bit  | 192k  | 2  | 12.3M | OK
|       | 16bit  | 384k  | 2  | 12.3M | OK
|       | 32bit  | 384k  | 2  | 24.6M | X

| version | Pian float192k2ch | happymp344.k2ch |   |   |
| log     |                   |                 |   |   |

还剩两个遗留问题

1. 384khz 32bit 2ch文件，发现存在卡顿问题。猜测是上层amnuplayer/mediacodec内部 decoder.ffmpeg有关线程内部的流控（nanosleep）之类存在问题
    <== 核心问题，应该还是外置usb读写速率的问题。换成内置sdcard的存储器，dd性能可以达到300Mbps。就没有这种问题，而外置usb的性能一般只有30Mbps
2. 多路数据流播放的问题。没有mixer，导致按键音没有。上层有概率性carsh

=== Audio DAC (from C302X C3 datasheet, pinmux part) ===

| AU_LOL | AO | - | AUdio DAC Line-Out Left channel signal  |
| AU_LOR |    |   | AUdio DAC Line-out Right channel signal |

AO: Analog output pin

颠倒下相关寄存器的配置即可

I2S DIN通道到I2S Rx，然后I2S Rx可以经过顺序和交错顺序输入到DAC

I2S DIN -> I2S Rx -> DAC -> DAC_inv -> DAC_VC(volume ctrl) -> DAC_Filter -> DAC_LR -> LOL,LOR


{{{
+------+
| DAC |
+-+--+-+
  X  X
+--------+
| I2S Rx |
+--------+
    ^
    |
    o I2S DIN
}}}

= 2023WK23 =
== USB-passthrough issue ==
测试codebase的基础Image状态
-> Mon: build uboot
    -> Wed: Still have problem
    -> Fri: C-media 的设备是可以识别的。其他设备：Generic 。。和Lavaudio DS600都无法识别

== Qinuo ==
Test base image with tinycap command (with new patch file on DTS)
    -> Mon: tinycap works, but only noise data
    -> Wed: ms12 lib + efuse

== C3 pop when start of playback ==
Saisai check
-> mute_pa
-> Jiebing TDM loopback rerord, find noise

-> 重试确认上次的影响
    -> 重复的0xA5这样的pattern，怀疑是frddr/tdm的reset问题。
    **在没有reset的情况下，残余在TDM/FRDDR中的数据会在下一次播放出来**
    **如果在播放结束的时候填零，或者增加reset，可以避免这类问题**
-> memset问题？
-> cache? <- 应该没问题
aud_dma_malloc -> CALL_PMZ_MALLOC_PMB_UNCACHE("audio_dma_buf") -> pmz_malloc_pmb_uncache
    -> pmz_manage.c -> pmb_alloc, pmb_map_kernel -> pmbs_map_kernel(0)
    -> allocator.pmb_map_kernel(0)

    pmb_map_kernel_cache(pmbs_map_kernel(1)

Thu: add dma_buffer size's filling-zero data to reset TDM/FRDDR
-> __FINAL Solution: It works__

物理角度看

dts文件中配置如下,这里配置为GPIOD_0,1 接口。这个接口在原理图中，连接到SPK_MUTE
或者LINE out mute上。gpio为高电平有效。

{{{
		avout_mute-gpios = <&gpio GPIOD_0 GPIO_ACTIVE_HIGH>;
		hp_mute-gpios = <&gpio GPIOD_1 GPIO_ACTIVE_HIGH>;
}}}

device初始化的时候，拿到dts配置。
{{{
	g_av_mute = osal_devm_gpiod_get_optional(ma_dev,
			"avout_mute", OSAL_GPIOD_OUT_LOW);
	hp_mute = osal_devm_gpiod_get_optional(ma_dev,
			"hp_mute", OSAL_GPIOD_OUT_LOW);
	msleep(10);
	if (!OSAL_IS_ERR(g_av_mute))
		osal_gpiod_direction_output(g_av_mute, OSAL_GPIOD_OUT_HIGH);
	if (!OSAL_IS_ERR(hp_mute))
		osal_gpiod_direction_output(hp_mute, OSAL_GPIOD_OUT_HIGH);
}}}

然后设置为high为输出

== C2 aec function ==
- TaoQin: check arecord result


= USB pass through code review in trunk =
== Tue 2023-07-25 ==
- [x] SND FS enable in trunk
- [ ] AC4 test stream

当前工作
- Dolby Passthrough + hi-res for USB
- ESPON 全民K歌

- BT/USB latency
- Loopback duplicated的需求（还在继续讨论）
- DSD over PCM, DSD native for USB issue

= Saisai当前工作2023WK31 =
- AEC effect CL整理
- Return value of MBP 修改
- AEC for HFP

- DRC API接口
- MBP AW402 pop noise

= HFP =

1. param_set 0 'hfp_enable=true'
2. check HFP flow
3. replace with loopback device
4. add aec process

/mnt/fileroot2/yang.liu/FY23/trunk.bds/hardware/amlogic/audio/audio_hal/aml_hfp.c:145:21

= Re-test Dolby passthrough feature & hi-res for USB =
1. SDK version, connection function, refine
2. sample rate not default one (due to proxy change)
3. BT & alsa dual output
== 2023-08-04 ==
S5 AX201 AS928X
proc fs
MS12 lib

| 0xE0000000 | DIRECT, OFFLOAD | HDMI | OK |
| 0xA0000000 | DIRECT, OFFLOAD | HDMI | OK |
| PCM        | 2ch             | HDMI | OK |

policy
- device USB_HEADSET, truehd, 48k, 1/2ch
- output truehd, 48k..192k, 1/2/3/../8ch, direct|offload **NO USB**
- output offload usb, 48k, 1/2ch, none, USB

- [x] fix flag
- [ ] policy flag ' '/'|' which one?


= 2023WK32 =
== OTT-46608 ==
- wav stability issue
period=5ms*2 -> 32ms*4

- [X] fix wav playback noise

- noise when truehd
1. dump input file when out_write_new
MLP (from dolby truehd)
PCM

./msd_ac4_generic_float32_release -im 1.mpl -oms 1.wav

- [X] MLP is good
- [X] aux retry, no related
- [ ] volume

| USB  | 0.1 | 1 | BAD  |
| USB  | 1   | 1 | GOOD |
| HDMI | ??  | ? | BAD  |
| HDMI | 1   | ? | GOOD |

apply volume for aux to debug


aux_app -> dolby_ms12_system_process -> dolby_ms12_input_system
main -> aml_audio_ms12_render -> aml_audio_ms12_process aml_audio_ms12_process_wrapper -> dolby_ms12_main_process -> dolby_ms12_input_associate
dolby_ms12_app_prcess -> dolby_ms12_input_app

2. dump input of usb_out_write, it have noise

3. MS12 path

- MS12 callback == ms12_output
- stereo_pcm_output_l? stereo_pcm_output
- ms12_output_master
- hw_write

4. SRC feature

- [X] hi-res stream doesn't dispatch to HAL
    - [X] need update policy (dynamic)
    - [X] check dynamic profile
- [X] nego with usb rate
- [X] dynamic open usb with rates
- [X] truehd fail (due to dynamic channel, it doesn't check with fixed policy xml ??? WHY?)

5. 32bit only device support

hack in profile

/mnt/fileroot2/yang.liu/FY23/koltin.BT_96K/system/media/alsa_utils/alsa_device_profile.c:176:9

6. volume

volume do effect in 

fade out cannot support

- original design of nonms12 render have this issue
- no continous task, it cannot fade out without output data when close

= WK33 =
- hi-res, USB passthrough for trunk
== PC -> DUT/HDMI-Rx -> DUT/HDMI-Tx -> AVR no audio ==
- jira: https://jira.amlogic.com/browse/SH-15324
P0, finish date: 0831
Test AVR: DENON SH-AVR-005 SH17150-094 AVR-X2400H

T7c AN400 Android-T

Update policy with HDMI-In to resolve part of issue

Codebase with repo init
repo init -u git://aml-code-master.amlogic.com/ref-o/platform/manifest.git -b t-tv-dev  -m  openlinux/bds/t-amlogic-20230531-bds.xml  --repo-url=git://10.8.9.5/tools/repo.git
*BOARD_COMPILE_HDMITX_ONLY=true*

-> /mnt/fileroot2/yang.liu/FY23/berlin.BDS/device/amlogic/t7_an400/BoardConfig.mk:67:9

out_write_new   GOOD
audio port
alsa write      ZERO

with MS12 lib

ms12 lib
/vendor/etc/init/dolby_fw_dolbyms12.rc

/vendor/bin/dolby_fw_dolbyms12 /odm/etc/ms12/libdolbyms12.so /odm/lib/ms12/libdolbyms12.so

Update policy

PCM output, HDMI-In & Local playback GOOD
XXX: DD output(auto), Local playback & HDMI-in BAD

- ms12_input_sys.pcm good 48k_2ch_16bit
- ms12_spdif_pcm.raw good 48k_2ch_16bit
    stereo_pcm_output
        /mnt/fileroot2/yang.liu/FY23/berlin.BDS/hardware/amlogic/audio/audio_hal/audio_hw_ms12_v2.c:2733:9
- ms12_bitstream.mat ? NOT
    bitstream_output
        /mnt/fileroot2/yang.liu/FY23/berlin.BDS/hardware/amlogic/audio/audio_hal/audio_hw_ms12_v2.c:2824:9
- alsa_spdif_write.mat ? NOT size too large
- alsa_pcm_write.raw good 48k_2ch_16bit

1. tinymix/HTMITX Audio Source Select=Spdif
2. tinymix/Audio Spdif format=Dolby TrueHD
3. ms12_output/optical_format=0x24000000 (MAT)

    It's conflict

We should output with TDM device when MAT format

/mnt/fileroot2/yang.liu/FY23/berlin.BDS/hardware/amlogic/audio/audio_hal/aml_audio_spdifout.c:77:95

{{{
    /* for MAT, if json config that mat output by i2s, then we should select tdm */
    if (phandle->audio_format == AUDIO_FORMAT_MAT && bd_config->hdmitx_hbr_src >= AML_TDM_A_TO_HDMITX)
        device_id = TDM_DEVICE;
}}}

1554: test aml_audio_config.json HDMITX_Src_Select: 3 => still BAD
HDMITX_Src_Select: 4 =>

|             | md5  | PCM  | Audio/DD |
| original    | d274 | Good | BAD      |
| my_codebase | 561d | XXX: |          |
| my+mute     | d4bf | Good |          |

- a67c: is_TV (true, TV_AUDIO_OUTPUT) is_BDS = false;
- 0e0e: force to TDM device
- force to TDM_C

<<< spdif out open fail

|                | md5               |   |
| rongqi         | d274              |   |
| rongqi         | aaa1 +spdif debug |   |
| force to TDM   |                   |   |
| WHY SRC is -1? | *HBR*             |   |
| +force TDM-C   | 1100              |   |
| refine code    | 5f5c              |   |

TDM_DEVICE -(audio_hw_utils.c/alsa_device_get_port_index)-> PORT_I2S2HDMI
    -(alsa_device_parser.c/alsa_device_update_pcm_index)-> -1

== 全民k歌 ==
- JIRA: https://jira.amlogic.com/browse/TV-72721
- Page: https://confluence.amlogic.com/pages/viewpage.action?pageId=283706155
P1, finish date: 0825

Serial Config: driver of Windows
baud rate:  115200
data:       8bit
parity:     none
stop:       1bit
flow control: *NONE*

adb 开启方式

4kTV (@dan.chen)

adev_set_parameters(direct-mode=1)
    /mnt/fileroot2/yang.liu/FY23/wiener.epson/hardware/amlogic/audio/audio_hal/audio_hw.c:4408:22
out_write_new (close stream, sleep, and fake to playback)
    /mnt/fileroot2/yang.liu/FY23/wiener.epson/hardware/amlogic/audio/audio_hal/audio_hw.c:7599:15
out_pause_new ->>
out_standby_new ->>
audio_patch_output_threadloop ->>
    do_output_standby_l ->
        /mnt/fileroot2/yang.liu/FY23/wiener.epson/hardware/amlogic/audio/audio_hal/audio_hw.c:5193:1
    out_write_new line7694 ->

usecase_change_validate_l send MS12_SCHEDULER_STANDBY

When playing music, audioserver PID use pcmC0D1p to playback
When switch to karaoke, aoke.micmanager use that device to playback

system notify HAL by 'direct-mode=1' to release device, and let aoke.micmanager to take it.

@zeming.huang 2022-01-17 develop this feature
fix solution: https://scgit.amlogic.com/#/c/243526/
duplicated issue: https://jira.amlogic.com/browse/TV-59747
*Resolved*

== Hi-Res spdif 176k to 48k ==
JIRA: https://jira.amlogic.com/browse/OTT-45861
P2, finish date: NO

已检查设备不支持176k，导致没有下发176k的stream下来。无法进行hi-res输出

*Resolved*: multi pcm need config 176400 PCM

== ADT-4 SC2 S905X4 hifi support ==

hifi4rpc_client_test --tinycap
/mnt/fileroot2/yang.liu/hifi4/workspace/dsp_util/hifi4rpc_test/hifi4rpc_pcm_test.c:722:17

== other ==
get_hdmi_sink_cap_new why return 352800 multiple times?

/mnt/fileroot2/yang.liu/FY23/koltin.BT_96K/hardware/amlogic/audio/audio_hal/audio_hw_profile.c:938:51

= FY23 codebase =

| Path          | FAE                      | Project             | LUD        | Comment                     |
| berlin.BDS    | @Qitao,@Rongqi           | BDS project         | 2023-08-29 |                             |
| Cantor.C3     | @Qiang.Wei,@Xinjun.Zheng | C3 doorbell project |            |                             |
| jordan.jieke  | @Mountain                | Jieke               | 2023-09-14 |                             |
| koltin.BT_96K | @Jihui                   | Hi-Res feature      | 2023-08-28 | update to 20230309 aosp.xml |
| qinglai.qinuo | @Mountain                | Qinuo project       | Outdated?  |                             |
| trunk.bds     | @Daozai                  | Trunk               | 2023-09-04 |                             |
| wiener.epson  | @White                   | 全民k歌             | outdated?  |                             |

= WK34 =
== DD format no audio? ==
- JIRA: https://jira.amlogic.com/browse/OTT-47896
P0, finish date: 0825
project: gazelle 后续问题
start: WK33

- ms12_force_ddp_out

note: input stream type use DDP for DD & DDP stream

msd_ac4_generic_float32_release -it DDP -im alsa_spdif_write.ddp -oms ddp.wav
msd_ac4_generic_float32_release -it DDP -im alsa_spdif_write.dd -oms dd.wav

*Resolve: Transferred to @Zongdong.Jiao*

= AudioHAL Refine =
TODO:
- render
- device
- input
== output module abstract ==

Support

- alsa output
- spdif output
- USB (proxy)
- A2DP

= ALSA driver =
== snd_pcm_link ==
The two PCMs will start/stop/prepare in sync.

/mnt/fileroot2/yang.liu/FY23/trunk.bds/common-5.15/common/sound/core/pcm_native.c:2249:5
core function is : snd_pcm_group_assign

snd_pcm_action -> {snd_pcm_action_group, snd_pcm_action_single}
snd_pcm_action_group -> foreach in group
    pre_action; do_action; undo_action (when fail); post_action
/mnt/fileroot2/yang.liu/FY23/trunk.bds/common-5.15/common/sound/core/pcm_native.c:1212:61

<<< pure software implementation
<<< delay of two device 没有保证的机制

Streams synchronization

There are two functions allowing link multiple streams together. In the case, the linking means that all operations are synchronized. Because the drivers cannot guarantee the synchronization (sample resolution) on hardware lacking this feature, the snd_pcm_info_get_sync() function returns synchronization ID - snd_pcm_sync_id_t, which is equal for hardware synchronized streams. When the snd_pcm_link() function is called, all operations managing the stream state for these two streams are joined. The opposite function is snd_pcm_unlink().

<<< snd_pcm_sync_id_t 这里没特别理解清楚

Related CL: https://patchwork.kernel.org/project/alsa-devel/patch/20190122161915.8445-6-tiwai@suse.de/

= How to config 'configurable policy' =
- xml with processing instruction?
- xml with xsd? schema?
- Intel's configurable policy is deprecated
- sed/awk
    - is ugly but works

    SED solution

=== xml with xinclude/xpointer/sed ===
build/make/core/Makefile:72: error: real file "out/target/product/t7_an400/vendor/etc/my_audio_policy_configuration.xml" depends on PHONY target "final.xml"

/mnt/fileroot2/yang.liu/FY23/trunk.bds/build/make/Changes.md:408:1

"xmllint" is not allowed to be used. See https://android.googlesource.com/platform/build/+/master/Changes.md#PATH_Tools 

TODO:
- [ ] xmllint is bad, we could static xinclude without expanding
- [ ] static put many feature type enabled version for QA

== MBP ==
- loopback config
/mnt/fileroot2/yang.liu/FY23/Cantor.C3/vendor/amlogic/ipc/mbp/mbd/audio/src/audio/audio_new/audio_board.c:49:45

= Google AEC at DSP =
google aec interface
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/hardware/amlogic/audio/audio_hal/google_aec.h:32:1

= WK35 =
== rtos T3x profile build fail ==
assign to @Jiebing to handle

*WON'T FIX*: git clone --recursive

== USB proxy prepare issue ==
Subject:    [T963D4_AY301][{Android S][Video call] After unplugging/plugging in the USB camera, enter the video call again, and the USB camera cannot record，1/15
JIRA:       https://jira.amlogic.com/browse/SWPL-129472
Device:     logitech BRIO
            support 16k, 24k, 32k, 48k, 16bit, 2ch
Priority:   P1

Key Log:
alsa_device_proxy: Limiting sampling rate from 48000 to 32000.
modules.usbaudio.audio_hal: proxy_prepare error -22

WHY it consider 48k is unsupported???

*Xfered to @Saisai*

usb_audio_probe
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/card.c:855:3
snd_usb_create_streams
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/card.c:332:5
snd_usb_create_stream
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/card.c:211:8
snd_usb_parse_audio_interface
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/stream.c:1229:3
snd_usb_init_sample_rate
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/clock.c:602:10
set_sample_rate_v1
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/clock.c:451:3

/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/pcm.c:1669:15
snd_usb_playback_ops .hw_params = snd_usb_hw_params
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/pcm.c:562:8
configure_endpoints
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/pcm.c:444:12
snd_usb_endpoint_configure
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/endpoint.c:1332:9
snd_usb_init_sample_rate
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/clock.c:602:10
set_sample_rate_v1
/mnt/fileroot2/yang.liu/FY23/berlin.BDS/common-5.15/common/sound/usb/clock.c:451:3


/* quirk applied after snd_usb_ctl_msg(); not applied during boot quirks */
void snd_usb_ctl_msg_quirk(struct usb_device *dev, unsigned int pipe,
			   __u8 request, __u8 requesttype, __u16 value,
			   __u16 index, void *data, __u16 size)
{
	struct snd_usb_audio *chip = dev_get_drvdata(&dev->dev);

	if (!chip || (requesttype & USB_TYPE_MASK) != USB_TYPE_CLASS)
		return;

	if (chip->quirk_flags & QUIRK_FLAG_CTL_MSG_DELAY)
		msleep(20);
	else if (chip->quirk_flags & QUIRK_FLAG_CTL_MSG_DELAY_1M)
		usleep_range(1000, 2000);
	else if (chip->quirk_flags & QUIRK_FLAG_CTL_MSG_DELAY_5M)
		usleep_range(5000, 6000);
}

	DEVICE_FLG(0x046d, 0x084c, /* Logitech ConferenceCam Connect */
		   QUIRK_FLAG_GET_SAMPLE_RATE | QUIRK_FLAG_CTL_MSG_DELAY_1M),
	DEVICE_FLG(0x046d, 0x0991, /* Logitech QuickCam Pro */
		   QUIRK_FLAG_CTL_MSG_DELAY_1M | QUIRK_FLAG_IGNORE_CTL_ERROR),
	DEVICE_FLG(0x046d, 0x09a4, /* Logitech QuickCam E 3500 */
		   QUIRK_FLAG_CTL_MSG_DELAY_1M | QUIRK_FLAG_IGNORE_CTL_ERROR),

在USB协议中，"quirk"是指一种特殊的设备行为或特性，该特性不符合USB规范的要求，但仍然可以通过一些特殊的处理方式来支持和兼容。这些quirk常常是针对特定的设备或芯片，用于解决一些不兼容或兼容性问题。通过在USB设备驱动程序中引入quirk，可以使设备在不符合规范的情况下仍然能够正常工作。常见的quirk包括延迟响应时间、修改设备描述符等。

== OTT-48515 ==
Subject:    [Freesia118][ID1009078][S928X][11.0][]:BA001_8.00.96、5x Playback truehd source with 96k resample via usb speaker，the playback speed is doubled100%
JIRA:       https://jira.amlogic.com/browse/OTT-48515
Priority:   P2 -> P1
board:      S5 AX201 S928X
Image:      Download for tyson
Jenkins:    Tyson
Code:       Android R 32bit

推测rate选择不对的问题

- 5276, origin
- 282e, add log ->
- 93b3, use data's sample rate instead of stream's rate

具体选择用什么rate，这个需要更多测试

Non-ms12 render is supported.
For 96k truehd, it need support in ms12 render

mixer_main_buffer_write -> aml_audio_ms12_render/aml_audio_ms12_process_wrapper -> dolby_ms12_main_process -> ms12_output -> hw_write

dec -> switch (TrueHD) -> aml_iec_func -> 

- 5865 + d124, 没打印？？？
- 78a0, ms12_render (bypass decoder)
- 8f2c,

MS12 output path is 48khz, 我们需要更新流的属性（按照其他render的做法），不然直接利用流原始的96k，会导致播放速率变快

*Resolved*

增加ms12模式下，对于stream.config.rate的更新，这样它就会从96k truehd的原始96k，更新到ms12 output sr的48khz，从而保证正确输出

== memory overwrite of audioHAL ==
JIRA:       https://jira.amlogic.com/browse/SH-16140
Subject:    [CVTE][AR31BJ][T982][Android T-13][27954][audio]:[370W]HWAddressSanitizer 开启后开机遇到audio 部分遇到内存越界风险报错 100%
Priority:   P1
board:      T3 T982 AR31B
Image:      from @Qitao

@Qitao.Tang feedback

/mnt/fileroot2/yang.liu/FY23/trunk.bds/system/media/audio_route/audio_route.c:687:44
/mnt/fileroot2/yang.liu/FY23/trunk.bds/external/tinyalsa/mixer.c:554:1
/mnt/fileroot2/yang.liu/FY23/trunk.bds/common-5.15/common/include/uapi/sound/asound.h:1076:8

- Codebase
- Image
- Reproduce
- change
- 16:48, f1d3, 
- 17:49, add more log in route, change tag?
    - 19:10, fix wrong free on tlv
- add tail checking
**find tail overwrite**
- 20:19, tas5805, 32bit/64bit compatblity issue, kernel add log
    - 结构体的size一致的啊，那是什么问题啊？？？
- 11:38, fix access user buf panic issue
- 11:57, enlarge buffer, and add showXxd function
- 13:06, reset cursor in showXxd, fix cursor calculation
- 14:42, fix tlv->tlv to tlv
**Root Cause Located**
- 15:50, check with final solution

https://scgit.amlogic.com/353694

{{{
struct snd_ctl_tlv {
	unsigned int numid;	/* control element numeric identification */
	unsigned int length;	/* in bytes aligned to 4 */
	unsigned int tlv[0];	/* first TLV */
};
}}}
mount -t vfat -o rw /dev/block/sda1 /data/usb
remount         <= fail to boot after remount
setenforce 0

HWASan: https://source.android.com/docs/security/test/hwasan?hl=zh-cn
code:   https://codebrowser.dev/llvm/compiler-rt/lib/hwasan/hwasan_report.cpp.html

- 5.15 issue
- 5.4 ??
- 4.9 good

PB: https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/16297/console

CLList:
- 341196 enable log
- 353694 kernel remove tlv
- 354497 tinymix remove tlv
- 354251 AQ remove tlv

- [X] PB16399? https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/16399/
T7 AN400, it use 5707codec. This codec doesn't have issue on tlv
- [ ] PB16411  https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/16411/
T982 AR301 ARM64
- [ ] PB16564   https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/16564
BAD iamge (kernel with TLV bug)

SND_SOC_BYTES_TLV
SNDRV_CTL_ELEM_ACCESS_TLV_CALLBACK
tlv.c
/mnt/fileroot2/yang.liu/FY23/trunk.bds/common-5.15/common/sound/core/control.c:1867:17

SOC_SINGLE_TLV
tlv.p
control.c directly read from the buffer
/mnt/fileroot2/yang.liu/FY23/trunk.bds/common-5.15/common/sound/core/control.c:1812:14

EDID TODO

~~Fix in audio route part~~

2023-09-07 Solution: fix in kernel, tinymix, AQ part

=== next step ===

- tinymix checking like HWASan


== C2 AQ pre-process && post-process discussion ==

一个差的speaker/mic/structure是无法使用AQ弥补的

= WK36 =

== SH-15323 ==
JIRA:       https://jira.amlogic.com/browse/SH-15323
PCM only TV, no audio when select auto mode

hdmitx_src_select=3
| mode     | status       | device        | format    | hdmitx src |
| pcm mode | good         | TDM-B         | 48k16b2ch | SPDIF      |
| auto     | **no audio** | TDM-B & SPDIF | 48k16b2ch | TDM-B      |

hdmitx_src_select=0
| pcm mode | good         | TDM-B         | 48k16b2ch | SPDIF stereo pcm |
| auto     | **no audio** | TDM-B & SPDIF | 48k16b2ch | SPDIF stereo pcm |

hdmitx_src_select=-1
| pcm mode | good     | TDM-B | 48k16b2ch | SPDIF stereo pcm |
| auto     | **GOOD** | TDM-B | 48k16b2ch | SPDIF stereo pcm |

Solution: hdmitx_src_select <== -1

== aloop dicussion with Hisense/VHD ==
- VHD soft take all real audio driver
- aloop for audio HAL

= WK37 =
== OTT-48554 ==
JIRA:       https://jira.amlogic.com/browse/OTT-48554
Subject:    [杰科][GIEC][928X][R][audio]: 应用相关功能API--音频设置-HDMI音频-选择HDMI输出的音频格式功能

== OTT-48552 ==
JIRA:       https://jira.amlogic.com/browse/OTT-48552
Subject:    [杰科][GIEC][928X][R][audio]: 应用相关功能API--音频设置-解码格式-解码格式选择功能

== OTT-48547 ==
JIRA:       https://jira.amlogic.com/browse/OTT-48547
Subject:    [杰科][GIEC][928X][R][audio]: 应用相关功能API--音频设置-USB音频开关控制功能

打开，关闭

== CL port back to trunk ==
JIRA:       https://jira.amlogic.com/browse/SWPL-137568
Subject:    support USB device in primary HAL
- usb-passthrough
- hi-res

- [X] sync code
- [X] image? https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/15281/
    - [X] with defconfig https://scgit.amlogic.com/#/c/335031/
    - [ ] NO usb card at T7c AN400
    - [ ] https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/15374/
    - [ ] https://jenkins-sh.amlogic.com/job/android/job/Android_R/job/Android_R_Google_AOSP_PATCHBUILD/32226/
- [O] code porting
    - [X] profile
    - [X] ms12 lib
    - [X] d945 无声，为什么？？ <- ms12 lib
    - [X] 4c89 Rebase
    - [ ] d4cb refine

| stream           | origin      | +CL           |                                         |
| PCM              |             |               |                                         |
| mp3  happy       | 96k32b mix  | 48k16b2ch mix |                                         |
| AC3 48k6ch dd    | no audio    | mix           |                                         |
| eAC3 48k8ch ChID | no audio    | mix           |                                         |
| AC4  48k silent  | unsupported | 0x22000000    | direct compress_offload=0x11            |
| TrueHD 48k 8ch   | unsupported | unsupported   | 需要amnuplayer send direct,offload data |

amnuplayer: Jul 11

== SH16077 ==
Subject:    [Sonos Pinewood][A311D2/T7C][T-13][Audio]Auto mode,MAT AVR, HDMI play Atmos audio source after MAT sound source, MAT sound source format is recognized as ATMOS,And no sound output,100%
JIRA:       https://jira.amlogic.com/browse/SH-16077
            https://jira.amlogic.com/browse/SH-15323
            SH-15324 后续
Priority:   P2 -> P1

由@xiushan继续解决

Xiushan think format changing detect have issue

soft_parser
audio_type_parse on pcm buf
cur_audio_type
audio_type
audio_parse_get_audio_type
/mnt/fileroot2/yang.liu/FY23/koltin.BT_96K/hardware/amlogic/audio/audio_hal/audio_hw.c:7140:5

0x24000000 AUDIO_FORMAT_MAT
0x0a000000 AUDIO_FORMAT_E_AC3

~~codebase: berlin~~

1. enable dump, log

ATOMS test stream: Datmos_id_obj_voice_ddp.ec3
MAT test stream: Atmos_ChID_Voice_704_MAT2.mat

| ATOMS | eac3=2 | AUDIO_FORMAT_E_AC3=0x0a000000 |
| MAT   | mat=5  | AUDIO_FORMAT_MAT  =0x24000000 |

- parse result, GOOD
- detect flow, GOOD

2. Use Rongqi's codebase
3. Rongqi's code difference

| origin      | 229d | issue                                 |                   |
| +log        | a76e | DIFF                                  |                   |
| rongqi+log  | 7c12 | 确认现象                              |                   |
| rongqi+dump | b760 | 没有对应的log，也没有dump，为什么？？ | permission denied |
|             | 0c10 |                                       |                   |

4. Which port? device? WHY fail? config?
port=15/PORT_I2S4PARSER device=2

00-02: TDM-C-dummy-alsaPORT-i2s4parser soc:dummy-2 :  : playback 1 : capture 1

AudioALSADeviceParser: auge sound card, pAdd=0xb4000078dc8e2d20 fix alsaPORT:15 to :2
audio_format_parse: open device failed: cannot set hw params: Invalid argument

audio_raw_data_parse -> audio_type_parse (@Wei.Huang add this)
audio_type_parse_threadloop -> audio_type_parse

4.1 add log for config & confirm #4

Symmetric clock control, make fail to open TDM-C with 48khz (it playback 192khz)

tinypcminfo

5. add symmetric clk's code
5.1 side-effect: volume-up

WindowManager KeyEvent { action=ACTION_UP, keyCOde=KEYBOCD_VOLUME_UP)
AudioService: adjustStreamVolume

adb shell dumpsys audio | ag -A 10 '\- STREAM_MUSIC'


Root Cause:
i2s 4 parse 是 TDM-C device. 当使用TDM-C device播放的话，则会限制TDM-C device作为录音的打开支持的sample rate。
这种情况下，HDMI Rx的format parse打开TDM-C device失败。进而导致无法识别到ATOMS/MAT的格式切换。
解决方法
kernel内部修改，去掉TDM的symmetric rate限制（这个限制同一个TDM device上input和output必须按照同一个rate打开）
 
在解决问题后，发现另外一个独立问题，启动后播放无声，按音量键向上则声音正常输出
通过dumpsys audio检查STREAM MUSIC的音量发现，启动后，这个streamVolume设置为0. 音量键向上后则streamVolume正常
这个问题在policy/volume control部分。请Rongqi Wang 进一步确认是否引入其他有问题的CL，或者请相关工程师继续检查下

= WK38 =
== CL port back to trunk ==
JIRA:       https://jira.amlogic.com/browse/SWPL-137568
Subject:    support USB device in primary HAL
- usb-passthrough
- hi-res

- [X] sync code
- [X] image? https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/15281/
    - [X] with defconfig https://scgit.amlogic.com/#/c/335031/
    - [ ] NO usb card at T7c AN400
    - [ ] https://jenkins-sh.amlogic.com/job/android/job/Android_T/job/Android_T_Google_AOSP_PATCHBUILD/15374/
    - [ ] https://jenkins-sh.amlogic.com/job/android/job/Android_R/job/Android_R_Google_AOSP_PATCHBUILD/32226/
- [O] code porting
    - [X] profile
    - [X] ms12 lib
    - [X] d945 无声，为什么？？ <- ms12 lib
    - [X] 4c89 Rebase
    - [ ] d4cb refine

| stream           | origin      | +CL           |                                         |
| PCM              |             |               |                                         |
| mp3  happy       | 96k32b mix  | 48k16b2ch mix |                                         |
| AC3 48k6ch dd    | no audio    | mix           |                                         |
| eAC3 48k8ch ChID | no audio    | mix           |                                         |
| AC4  48k silent  | unsupported | 0x22000000    | direct compress_offload=0x11            |
| TrueHD 48k 8ch   | unsupported | unsupported   | 需要amnuplayer send direct,offload data |

amnuplayer: Jul 11

== C3 audio insmod too long ==
- acodec mdelay to 1ms
    - [ ] test result

= WK40 =
== crash when switch from SCO to A2DP ==
JIRA:       https://jira.amlogic.com/browse/SH-16144
Subject:    [恒毅][AR30A1][T982][Android R-11][26904][audio]:设备连接上蓝牙音响，播放视频，音频输出从sco切换到a2dp，audio hal发生crash. 1%

@Qitao.Tang feedback

- 2023-09-26 add log

allocation

int open_btSCO_device(struct aml_audio_device *adev, size_t frames)
    output_frames = frames * bt->cfg.rate / MM_FULL_POWER_SAMPLING_RATE + 1; // 683
    bt->bt_out_buffer = aml_audio_calloc(1, output_frames * 2); // 683*2=1366 => 5464=683*2*4
    // resampler config from 48k to 16k, **ch=2**

use
ssize_t write_to_sco(struct aml_audio_device *adev, audio_config_base_t *config,
    const void *buffer, size_t bytes)
    // channel_mask=0x3/2ch, format=1/16bit, bytes_per_sample=2, frame_size=4 in_frames=2048
    
    // 2048*16k/48k+1=682.67+1=683.67=683
    out_frames = in_frames * bt->cfg.rate / MM_FULL_POWER_SAMPLING_RATE + 1;
    frame_size /= 2; // 2, **it want discard right channel**
        // WHY logcat frame_size is still 4???
        bt->resampler->resample_from_input(bt->resampler,
                     bt->resampler_buffer, &res_in_frames,
                     (int16_t*)bt->bt_out_buffer, &out_frames);
        ret = pcm_write(bt->pcm_bt, bt->bt_out_buffer, out_frames * frame_size);

ACTION: pending @Qitao

是不是代码不一致啊？？

= WK41 =
== SWPL-14019 ==
DSP SC2 VAD interrupts conflict issue

== OTT_48976 ==
JIRA:       https://jira.amlogic.com/browse/OTT-48976
Subject:    [GAZELLEFOS-3606][Amazon][GAZELLE][AN40A3][POP1][Android P-9.0]:[EDT HDMI IOP] : Nvidia Shield Pro->Gazelle->Sink: Audio disappears and will not return after performing trick play operation

依然是RT throttle的问题

Solution:

With semaphore solution

Find new issue: https://jira.amlogic.com/browse/OTT-50881

== USB merge issue ==
JIRA:
Subject:
Priority:

com:        921600
adb:        mini-usb
test case:  USB device, playback

Image:      https://jenkins-sh.amlogic.com/job/android/job/Android_U/job/Android_U_Google_AOSP_AUTOBUILD_Run/146/
Wrong: production build, cannot switch to root
Image:      https://jenkins-sh.amlogic.com/job/android/job/Android_U/job/Android_U_Google_AOSP_AUTOBUILD_Run/144/
user debug build

~~T7 AN400 board, NO usb devices~~ There is usb audio device

- [X] 1009 14:42 basic work with PB144
- [ ] replace lib & xml
md5sum ORIGIN 4b28
md5sum 1b52
md5sum 8cc6 64bit version
- [ ] enable log
有新的track，但是没有新的stream。为什么没有到USB device？？？
- [ ] Need dolby lib

PB:         https://jenkins-sh.amlogic.com/job/android/job/Android_U/job/Android_U_Google_AOSP_PATCHBUILD/664/
- [X] support procfs for ALSA

- [X] With C-media 48k 16bit 2ch card, baseline case pass
- image baseline 7839, GOOD
- codebase baseline 33c5 with origin policy is GOOD
- 33c5 + my policy is BAD
- my code(f46c) + my policy ??? BAD 没声音

- enable log: fd6c
- WITH DOLBY LIB, this issue is GONE
dolby lib directory /oem/lib/ms12

=== 2nd stage: support submix ===
- 13c8: check flow
- 6e2c: more log
- 28cf: add usb in mixer_output_write

amlAudioMixer.c mixer_output_write ->
{
    sco; a2dp out write;
    default to alsa write, out_port->write = audio_port.c/input_port_write
}

is_include_usb_out_port one of USB ACCESSORY, USB DEVICE, USB HEADSET
- cur_out_devices, 没有USB为啥？？ 不是这里？？
compare with dolby version
    - dolby: add condition in hw_write, USB playback well

==== 2.1 stage: continue to support submix ====


= WK43 =
== OTT-48553 ==
JIRA:       https://jira.amlogic.com/browse/OTT-48553
Subject:    [杰科][GIEC][928X][R][audio]: 应用相关功能API--音频设置-光纤音频-选择光纤输出格式功能
Priority:   P1 -> P0 (deadline: 2023-10-27)
Codebase:   FY23/jordan.jieke

adev_set_parameters(hal_param_spdif_highest_rate=96000)?

Codebase with repo init

Requirement Link:
https://rp.mockplus.cn/run/kNoBfztDYe/q3GfRdX3yo/D7AMDNY3dnDI?cps=expand&rps=expand&nav=1&ha=0&la=0&fc=0&out=1&rt=1

1. [ ] add patch (USB, Hires)
2. [ ] improve patch

- image default, Happy mp3, and 96 stream all play as 48k 16bit 2ch
    - amnuplayer is May 5 2023
    - https://jenkins-sh.amlogic.com/job/android/job/Android_R/job/Android_R_DRM_PATCHBUILD/13528/
    - select p-amlogic branch, change "commit" to df0b51b, select "build amnuplayer" => FAIL
    - select p-amlogic branch, select "build amnuplayer" => build FAIL to due ffmpeg's function declaration
        https://jenkins-sh.amlogic.com/job/android/job/Android_R/job/Android_R_DRM_PATCHBUILD/13563/console

With this version, build pass: https://scgit.amlogic.com/#/c/367322/

amnuplayer -> 
hardware/amlogic/media/ammediaext e7552a

amnuplayer default md5=2705, git version: df0b51bf018edc621fae16f600868be15e300f23
my direct one: md5=4c9f

0. [X] MS12 lib
1. [X] my CL
2. [X] Hongchao's CL to support direct flag
NOTE: need ALL patch (individual output menu, patch in policy side (getOutput?)
3. [X] Amnuplayer to pass direct stream to FW
4. Policy file
5. [X] Property persist.vendor.audio.direct_device
NOTE: This point is individual with #2
6. [X] Capability of device? / Fake sample rate of TV

1026 11:01  check with hack TV CL   => Cannot dispatch direct stream with audio policy/engine's getOutputForAttrInt
     16:25  with Hongchao's ALL patch
     18:38  find direct stream      => with hires CL
     18:55  replace ALL lib         => original HACK CL
     19:13  with SPDIF->Line-out device + policy (direct pcm)
            MUSILAND SVDAC05 This device only support 96k pcm 16bit (not support 192k)
     19:40  +spdif highest rate CL

| version    | md5        | policy | load | play 48k | play 192k |
| origin lib | d68e       | Good   | Good | Good     | 48k       |
| +hack      | 11:01 59af |        | Good | Good     | 48k       |
| +hires     | 18:43 075a |        |      |          | 48k       |

= WK44 =
== OTT-50985 ==
JIRA:       https://jira.amlogic.com/browse/OTT-50985

fdsan problem
https://android.googlesource.com/platform/bionic/+/master/docs/fdsan.md

Wait for feedback

== OTT-50881 ==
noise Nvidia Shield -> gazelle

频繁的切换 ms12 dolby / pcm hires stream??

- [ ] dump hires stream
first 200ms data may introduce error as wrong detect raw to pcm

#00. 1097 dump per stream   >>>
pcm, all zero (hires)
pcm, 48khz 8ch 16bit NOISE?

#01, dump with tag          >>>
noise in hires?? data, middle of stream, how to filter out it?

#02, add log in audio-patch format change       >>>
11-06 19:06:57.464   388  6679 E audio_hw_primary-aml_audio_stream: yyy HDMI Format Switch [audio_packet pre:1->cur:1 changed:0] [channel pre:2->cur:2 changed:0], hires = 1 non_audio 0
11-06 19:06:57.464   388  6679 E audio_hw_primary-aml_audio_stream: yyy reconfig_read_param_through_hdmiin(), rate 48000->192000, fmt 0->0

11-06 19:11:25.915   388   681 I audio_hw_primary-alsa_manager: aml_alsa_output_write_new, alsa format =0x3 delay frames =640 total frames=768000
11-06 19:11:26.787   388  6679 E audio_hw_primary-aml_audio_stream: yyy HDMI Format Switch [audio_packet pre:1->cur:1 changed:0] [channel pre:2->cur:2 changed:0], hires = 1 non_audio 1
11-06 19:11:26.787   388  6679 E audio_hw_primary-aml_audio_stream: yyy reconfig_read_param_through_hdmiin(), rate 192000->48000, fmt 0->0
11-06 19:11:26.787   388  6679 I audio_hw_primary-aml_audio_stream: [reconfig_read_param_through_hdmiin:1532] ringbuffer size 98304

#03, add log (enable NDEBUG) + check reinit flow

patch_input_thread -> ???
hdmi_cfg? / reinit_out_thread
patch_output_thread(need_reinit_output_stream) -> adev_close_output_stream(hires/close)

#04, memset before out_write_new (It doesn't work). WHY not drop?

    8ms noise

#05, check_audio_level
audio_level after reinit check
#06, check non_audio flag
#07, clear only when after need_reinit_output_stream && level != 0
HDMIIN nonaudio NONAUDIO/PCM        192k pcm 16bit 2ch => hires
                                    192k nonaudio 16bit 2ch => dolby


#08, clear data when 1) need_reinit 2) dolby data init

| ---- hires stream ---------00 | 00---dolby stream --------- |

Solution::

1) after need_reinit_output_stream, memset
2) when switch to dolby stream, patch_write_cnt <= 20, memset

== USB on Android U ==
- [X] policy XML need update 2023-11-06 11:13:02
- [X] CTS passed
- [X] USB Audio Input/Output Test @Shengyu.Gu
- [X] auto submit 2023-11-08 11:23:51

== Cartographer ==
Slow at ARM A35, How to optimize it?

- [X] download, and built it
- check libeigen3 depend on arch part. NEON optimization is PARTLY work.
- openmp support
- dense matrix (4x4) operation is too frequent, mailbox is 10kHz
- I still suggest to optimize at ARM/NEON side.

== saisai far field with DSP ==
- rebase audio HAL's CL
- PB: https://jenkins-sh.amlogic.com/job/android/job/Android_U/job/Android_U_Google_ref_PATCHBUILD/9968/
- freertos's CL leaves alone: https://scgit.amlogic.com/#/c/371434/2

== WK 11-13 ==
== Merge Back ==

https://confluence.amlogic.com/display/SW/FY23+merge+back?src=contextnavpagetreemode

- [ ] improve log
- android U, true HD related CL
- hires related CL

== alsa manager refine ==
== refine of alsa manager ==

- [X] delay和position什么关系

SNDRV_PCM_IOCTL_DELAY
htimestamp -> SNDRV_PCM_SYNC_PTR_APPL | SNDRV_PCM_SYNC_PTR_HWSYNC ->

DELAY + position = buffer size

board:      T7 AN400
repo:       Android U
codebase:   upsidedown
CL:         https://scgit.amlogic.com/#/c/367732/

- [X] android U codebase, need procfs CL: https://scgit.amlogic.com/#/c/341196/1
PB https://jenkins-sh.amlogic.com/job/android/job/Android_U/job/Android_U_Google_AOSP_PATCHBUILD/1288/
- [X] base version, playback mp3, good 2023-11-13 14:52:49, md5=9e88
- [ ] rebase CL, add log, md5=f3e7
audioserver process is good
    - FAIL to replace lib
    - 64bit vs 32bit ? good
- add log in hw_write, output_base_open         md5=488b
    - >>> dcv version goto submixing -> output_porc -> pcm_write interface
    - verify that path                          md5=

with libdolbyms12

crash at audio_hw_ms12_v2.c     => switch to ms12_out->handle, add log md5=d886
open succ, fail to write??? 2023-11-15 15:51:38

= FFV + Suspend Resume flow =
android doc: https://source.android.com/docs/core/power/systemsuspend?hl=zh-cn
code: https://cs.android.com/android/platform/superproject/+/master:prebuilts/vndk/v33/x86/include/generated-headers/system/hardware/interfaces/suspend/1.0/android.system.suspend@1.0_genc++_headers/gen/android/system/suspend/1.0/ISystemSuspend.h;l=21?q=ISystemSuspend%20HIDL&sq=

Yujie 1e5f8e
A2dpSuspend -> a2dp_out_set_parameters -> a2dphw.Stop

Hongchao.Yin
hal_param_vad_wakeup -> aml_vad_suspend/aml_vad_resume
https://scgit.amlogic.com/#/c/317452/

ApmAudio/ApmOUtput -> suspendOutput -> af->suspendOutput -> PlaybackThread->suspend

suspend() { (void) android_atomic_inc(&mSuspended); }

Screen State


IDevice.hal
hardware/interfaces/audio/core/all-versions/default/Device.cpp setScreenState
services/audioflinger/AudioFlinger.cpp get (keyScreenState)
HAL AUDIO_PARAMETER_KEY_SCREEN_STATE on/off

https://developer.android.com/reference/android/os/PowerManager.html
= links=
== confluences ==
DSK SDK Release flow
https://confluence.amlogic.com/display/FCP/DSP+SDK+release+flow

@HongChao.Yin Amlogic Debug Tool
https://confluence.amlogic.com/display/SQA/Amlogic+Debug+tool

2023 Audio Platform Work Log
https://docs.qq.com/doc/DUXNZWnN3akRUVGJ0

AATS
http://aats.amlogic.com:10000/weekly_sumup/

== History ==
AEC summary: https://confluence.amlogic.com/display/~Yang.Liu/ART+test+eraser+case+summary

Android U codebase: https://confluence.amlogic.com/pages/viewpage.action?spaceKey=SW&title=Android+U+A311D2+64bit
